<!DOCTYPE html>
<html>
<head>
    <title>é¹¿é€”æ‹¼æ‹¼ - æ‰«ç æ ¸é”€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- æ·»åŠ  PWA ç›¸å…³ meta æ ‡ç­¾ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="/shared/base.css">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        .scan-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 12px var(--shadow-color);
            position: relative;
        }

        .scan-title {
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        #reader {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            border: 2px solid var(--secondary-light);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        #result {
            margin: 20px auto;
            padding: 20px;
            border-radius: 12px;
            background: var(--background-light);
            max-width: 600px;
            transition: all 0.3s ease;
        }

        .success {
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
            padding-left: 15px;
            background: rgba(76, 175, 80, 0.1);
        }

        .error {
            color: var(--error-color);
            border-left: 4px solid var(--error-color);
            padding-left: 15px;
            background: rgba(255, 112, 67, 0.1);
        }

        .scan-decoration {
            position: absolute;
            width: 100px;
            height: 100px;
            opacity: 0.1;
            pointer-events: none;
        }

        .scan-decoration-tl {
            top: 20px;
            left: 20px;
            border-top: 4px solid var(--primary-color);
            border-left: 4px solid var(--primary-color);
            border-top-left-radius: 16px;
        }

        .scan-decoration-tr {
            top: 20px;
            right: 20px;
            border-top: 4px solid var(--primary-color);
            border-right: 4px solid var(--primary-color);
            border-top-right-radius: 16px;
        }

        .scan-decoration-bl {
            bottom: 20px;
            left: 20px;
            border-bottom: 4px solid var(--primary-color);
            border-left: 4px solid var(--primary-color);
            border-bottom-left-radius: 16px;
        }

        .scan-decoration-br {
            bottom: 20px;
            right: 20px;
            border-bottom: 4px solid var(--primary-color);
            border-right: 4px solid var(--primary-color);
            border-bottom-right-radius: 16px;
        }

        /* æ·»åŠ æ ¸é”€ç»“æœæ˜¾ç¤ºåŒºåŸŸæ ·å¼ */
        .verify-result-container {
            margin-top: 30px;
            text-align: center;
        }

        #result {
            font-size: 18px;
            padding: 15px 25px;
            border-radius: 12px;
            margin: 20px auto;
            max-width: 400px;
            transition: all 0.3s ease;
        }

        #result.success {
            background: rgba(var(--success-rgb), 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        #result.error {
            background: rgba(var(--error-rgb), 0.1);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        /* æ ¸é”€æˆåŠŸåŠ¨ç”»æ ·å¼ */
        .verify-success-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            z-index: 1000;
            min-width: 300px;
            position: relative;
        }

        .success-icon {
            font-size: 48px;
            color: var(--success-color);
            margin-bottom: 20px;
        }

        .success-text h3 {
            font-size: 24px;
            color: var(--success-color);
            margin-bottom: 15px;
        }

        .activity-info {
            margin-top: 20px;
            padding: 15px;
            background: var(--background-light);
            border-radius: 12px;
        }

        .activity-info p {
            margin: 8px 0;
            color: var(--text-color);
        }

        .activity-info .label {
            font-weight: 500;
            color: var(--text-light);
        }

        .activity-info .value {
            font-weight: bold;
            color: var(--primary-color);
        }

        /* æ·»åŠ å…³é—­æŒ‰é’®æ ·å¼ */
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--background-light);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .close-button:hover {
            background: var(--background-dark);
            color: var(--text-color);
        }

        .quota-exceeded-icon {
            font-size: 48px;
            color: var(--warning-color);
            margin-bottom: 20px;
        }

        h3.quota-exceeded {
            color: var(--warning-color);
        }

        .quota-message {
            margin-top: 15px;
            padding: 10px;
            background: rgba(var(--warning-rgb), 0.1);
            border-radius: 8px;
            color: var(--warning-color);
            font-weight: 500;
        }

        /* ç§»åŠ¨ç«¯æ‰«ç ç•Œé¢ä¼˜åŒ– */
        @media screen and (max-width: 768px) {
            .scan-container {
                margin: 10px;
                padding: 15px;
            }

            .scan-title {
                font-size: 20px;
                margin-bottom: 20px;
            }

            #reader {
                border-radius: 12px;
                overflow: hidden;
            }

            /* éšè—HTML5 QRæ‰«æå™¨çš„ä¸€äº›ä¸å¿…è¦å…ƒç´  */
            #reader__dashboard_section_csr button {
                font-size: 14px !important;
                padding: 8px 12px !important;
            }

            #reader__filescan_input {
                width: 100% !important;
                margin: 10px 0 !important;
            }

            /* ä¼˜åŒ–ç»“æœæ˜¾ç¤º */
            #result {
                font-size: 16px;
                padding: 12px 20px;
            }

            /* ä¼˜åŒ–æˆåŠŸåŠ¨ç”» */
            .verify-success-animation {
                width: 90%;
                padding: 20px;
            }

            .success-icon {
                font-size: 36px;
            }

            .activity-info {
                margin-top: 15px;
                padding: 12px;
            }

            .activity-info p {
                margin: 6px 0;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="nav-links">
        <a href="/merchant/dashboard" class="nav-link">ä¸»é¡µ</a>
        <a href="/merchant/verify" class="nav-link">æ‰«ç æ ¸é”€</a>
        <a href="/merchant/records" class="nav-link">æ ¸é”€è®°å½•</a>
        <a href="/merchant/profile" class="nav-link">ä¸ªäººä¿¡æ¯</a>
        <a href="/merchant/logout" class="nav-link">é€€å‡ºç™»å½•</a>
    </div>

    <div class="scan-container">
        <div class="scan-decoration scan-decoration-tl"></div>
        <div class="scan-decoration scan-decoration-tr"></div>
        <div class="scan-decoration scan-decoration-bl"></div>
        <div class="scan-decoration scan-decoration-br"></div>
        
        <h1 class="scan-title">
            <span class="deer-icon">ğŸ¦Œ</span>
            æ‰«ç æ ¸é”€
        </h1>
        <div id="reader"></div>
        <div class="verify-result-container">
            <div id="result"></div>
        </div>
    </div>

    <script>
        let isProcessing = false; // æ·»åŠ æ ‡å¿—é˜²æ­¢é‡å¤æäº¤
        let lastScannedCode = null; // è®°å½•ä¸Šæ¬¡æˆåŠŸæ‰«æçš„äºŒç»´ç 
        let lastScanTime = 0; // è®°å½•ä¸Šæ¬¡æˆåŠŸæ‰«æçš„æ—¶é—´

        // ä¿®æ”¹æ‰«ç å™¨é…ç½®ï¼Œç®€åŒ–å¹¶ä¼˜åŒ–é…ç½®
        const html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { 
                fps: 10,
                qrbox: {
                    width: Math.min(250, window.innerWidth - 50),
                    height: Math.min(250, window.innerWidth - 50)
                },
                aspectRatio: 1.0,
                formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ],
                // ä½¿ç”¨é»˜è®¤æ‘„åƒå¤´è®¾ç½®
                videoConstraints: {
                    facingMode: { ideal: "environment" }
                }
            }
        );

        // ä¿®æ”¹åˆå§‹åŒ–å‡½æ•°
        async function initializeCamera() {
            try {
                console.log('å¼€å§‹åˆå§‹åŒ–æ‘„åƒå¤´...');
                
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.mediaDevices) {
                    navigator.mediaDevices = {};
                }

                // ç›´æ¥åˆå§‹åŒ–æ‰«ç å™¨
                await html5QrcodeScanner.render(
                    (decodedText) => {
                        console.log('æ‰«æåˆ°äºŒç»´ç :', decodedText);
                        onScanSuccess(decodedText);
                    },
                    (error) => {
                        // åªè®°å½•çœŸæ­£çš„é”™è¯¯
                        if (error?.message?.includes('NotFound')) {
                            console.error('æ‰«æé”™è¯¯:', error);
                        }
                    }
                );

                console.log('æ‰«ç å™¨åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('æ‘„åƒå¤´åˆå§‹åŒ–é”™è¯¯:', error);
                showError(error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½åå†åˆå§‹åŒ–
            if (document.readyState === 'complete') {
                initializeCamera();
            } else {
                window.addEventListener('load', initializeCamera);
            }
        });

        // ä¿®æ”¹æ‰«ææˆåŠŸçš„å¤„ç†å‡½æ•°
        async function onScanSuccess(decodedText) {
            const now = Date.now();
            
            // å¦‚æœæ­£åœ¨å¤„ç†ä¸­ï¼Œåˆ™å¿½ç•¥
            if (isProcessing) {
                return;
            }

            // å°è¯•è§£æäºŒç»´ç æ•°æ®
            let qrData;
            try {
                qrData = JSON.parse(decodedText);
                
                // éªŒè¯äºŒç»´ç æ•°æ®å®Œæ•´æ€§
                if (!qrData || !qrData.activityId || !qrData.codeId) {
                    return; // é™é»˜å¿½ç•¥ä¸å®Œæ•´çš„æ‰«æç»“æœ
                }
            } catch (error) {
                return; // é™é»˜å¿½ç•¥è§£æé”™è¯¯
            }

            const currentCode = qrData.codeId;

            // å¦‚æœæ˜¯åŒä¸€ä¸ªäºŒç»´ç ï¼Œå¹¶ä¸”é—´éš”å°äº5ç§’ï¼Œåˆ™å¿½ç•¥
            if (currentCode === lastScannedCode && (now - lastScanTime) < 5000) {
                return;
            }

            try {
                isProcessing = true;
                lastScannedCode = currentCode;
                lastScanTime = now;

                const response = await fetch('/api/verify-qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        qrData: decodedText
                    })
                });

                if (!response.ok) {
                    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                }

                const result = await response.json();
                
                // æ˜¾ç¤ºç»“æœ
                showResult(result.message, result.success);
                
                // å¦‚æœæ ¸é”€æˆåŠŸï¼Œæ˜¾ç¤ºåŠ¨ç”»å’Œæ›´æ–°ç»Ÿè®¡
                if (result.success && result.activity) {
                    showVerifySuccess(result.activity);
                    try {
                        await updateStats(); // ç­‰å¾…ç»Ÿè®¡æ›´æ–°å®Œæˆ
                    } catch (error) {
                        console.error('Failed to update stats:', error);
                    }
                }

            } catch (error) {
                console.error('Verification error:', error);
                if (error.name === 'NotAllowedError') {
                    showResult('è¯·å…è®¸è®¿é—®æ‘„åƒå¤´', false);
                } else {
                    showResult('æ ¸é”€å¤±è´¥ï¼Œè¯·é‡è¯•', false);
                }
            } finally {
                setTimeout(() => {
                    isProcessing = false;
                }, 2000);
            }
        }

        function onScanError(error) {
            console.warn(`æ‰«ç é”™è¯¯: ${error}`);
        }

        function showResult(message, success) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = success ? 'success' : 'error';
            resultDiv.textContent = message;

            // 3ç§’åæ¸…é™¤ç»“æœæ˜¾ç¤º
            setTimeout(() => {
                resultDiv.textContent = '';
                resultDiv.className = '';
            }, 3000);
        }

        function showVerifySuccess(activity) {
            // ç§»é™¤æ‰€æœ‰ç°æœ‰çš„åŠ¨ç”»
            document.querySelectorAll('.verify-success-animation').forEach(el => {
                el.remove();
            });

            const successAnimation = document.createElement('div');
            successAnimation.className = 'verify-success-animation';
            
            // å¦‚æœæ˜¯é…é¢ç”¨å®Œçš„æƒ…å†µ
            if (!activity.success && activity.endReason === 'QUOTA_EXCEEDED') {
                successAnimation.innerHTML = `
                    <button class="close-button" onclick="closeSuccessAnimation(this.parentElement)">Ã—</button>
                    <div class="quota-exceeded-icon">ğŸ”’</div>
                    <div class="success-text">
                        <h3 class="quota-exceeded">æ´»åŠ¨å·²ç»“æŸ</h3>
                        <div class="activity-info">
                            <p>
                                <span class="label">æ´»åŠ¨åç§°ï¼š</span>
                                <span class="value">${activity.name}</span>
                            </p>
                            <p>
                                <span class="label">æ´»åŠ¨ç±»å‹ï¼š</span>
                                <span class="value">${getActivityTypeName(activity.type)}</span>
                            </p>
                            <p>
                                <span class="label">é…é¢æƒ…å†µï¼š</span>
                                <span class="value">${activity.usedQuota}/${activity.totalQuota}</span>
                            </p>
                            <p class="quota-message">
                                æ­¤æ´»åŠ¨é…é¢å·²ç”¨å®Œï¼Œæ— æ³•ç»§ç»­æ ¸é”€
                            </p>
                        </div>
                    </div>
                `;
            } else {
                // æˆåŠŸæ ¸é”€æ˜¾ç¤º
                successAnimation.innerHTML = `
                    <button class="close-button" onclick="closeSuccessAnimation(this.parentElement)">Ã—</button>
                    <div class="success-icon">âœ“</div>
                    <div class="success-text">
                        <h3>æ ¸é”€æˆåŠŸ</h3>
                        <div class="activity-info">
                            <p>
                                <span class="label">æ´»åŠ¨åç§°ï¼š</span>
                                <span class="value">${activity.name}</span>
                            </p>
                            <p>
                                <span class="label">æ´»åŠ¨ç±»å‹ï¼š</span>
                                <span class="value">${getActivityTypeName(activity.type)}</span>
                            </p>
                            <p>
                                <span class="label">é…é¢ä½¿ç”¨ï¼š</span>
                                <span class="value">${activity.usedQuota}/${activity.totalQuota}</span>
                            </p>
                            <p>
                                <span class="label">å‰©ä½™é…é¢ï¼š</span>
                                <span class="value">${activity.remainingQuota}</span>
                            </p>
                            <p>
                                <span class="label">æ ¸é”€æ—¶é—´ï¼š</span>
                                <span class="value">${formatDate(new Date())}</span>
                            </p>
                        </div>
                    </div>
                `;
            }

            // ä¿®æ”¹å…³é—­æŒ‰é’®çš„å¤„ç†
            const closeButton = successAnimation.querySelector('.close-button');
            if (closeButton) {
                closeButton.onclick = () => {
                    successAnimation.style.opacity = '0';
                    setTimeout(() => {
                        successAnimation.remove();
                    }, 300);
                };
            }

            document.body.appendChild(successAnimation);

            // è‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (successAnimation && document.body.contains(successAnimation)) {
                    successAnimation.style.opacity = '0';
                    setTimeout(() => {
                        if (document.body.contains(successAnimation)) {
                            successAnimation.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        // ç®€åŒ–å…³é—­åŠ¨ç”»å‡½æ•°
        function closeSuccessAnimation(element) {
            if (element && document.body.contains(element)) {
                element.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(element)) {
                        element.remove();
                    }
                }, 300);
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // è·å–æ´»åŠ¨ç±»å‹åç§°
        function getActivityTypeName(type) {
            const typeNames = {
                'normal': 'æ™®é€šæ´»åŠ¨',
                'free': 'å…è´¹æ´»åŠ¨',
                'discount': 'æŠ˜æ‰£æ´»åŠ¨',
                'buy_one_get_one': 'ä¹°ä¸€é€ä¸€'
            };
            return typeNames[type] || type;
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        async function updateStats() {
            const response = await fetch('/merchant/verify/stats');
            const stats = await response.json();
            document.getElementById('todayCount').textContent = stats.today;
            document.getElementById('totalCount').textContent = stats.total;
        }

        // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œé‡æ–°åˆå§‹åŒ–æ‘„åƒå¤´
                html5QrcodeScanner.resume();
            } else {
                // é¡µé¢ä¸å¯è§æ—¶ï¼Œæš‚åœæ‘„åƒå¤´
                html5QrcodeScanner.pause();
            }
        });

        function showError(error) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'error';
            
            let errorMessage = 'æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥';
            let solution = 'è¯·åˆ·æ–°é¡µé¢é‡è¯•';

            if (error.name === 'NotAllowedError') {
                errorMessage = 'è¯·å…è®¸è®¿é—®æ‘„åƒå¤´';
                solution = 'ç‚¹å‡»æµè§ˆå™¨åœ°å€æ çš„æ‘„åƒå¤´å›¾æ ‡ï¼Œé€‰æ‹©"å…è®¸"';
            } else if (error.name === 'NotFoundError') {
                errorMessage = 'æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡';
                solution = 'è¯·ç¡®ä¿è®¾å¤‡æœ‰å¯ç”¨çš„æ‘„åƒå¤´';
            }

            resultDiv.innerHTML = `
                <div class="error-message">
                    <p>${errorMessage}</p>
                    <p class="solution">${solution}</p>
                    <button onclick="retryCamera()" class="retry-button">é‡è¯•</button>
                </div>
            `;
        }

        // æ·»åŠ é‡è¯•å‡½æ•°
        async function retryCamera() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'æ­£åœ¨é‡æ–°åˆå§‹åŒ–æ‘„åƒå¤´...';
            resultDiv.className = '';
            
            try {
                await html5QrcodeScanner.clear();
                await initializeCamera();
            } catch (error) {
                console.error('é‡è¯•å¤±è´¥:', error);
                showError(error);
            }
        }
    </script>
</body>
</html>